library(tidyverse)
library(sqldf)
library(stringr)
library(readxl)

setwd('C:/Users/aecun/OneDrive/Documents/Blackpool Mapping/mapdata')

# NB - except for Standardised Ratios, the variable must already be in the Metadata.csv file, 
# because we need to take the England average from the 'DivergePoint' column
metadata <- read_csv("Metadata.csv")

# Reading Nomis data on single person households

SinglePerson <- read.csv('https://www.nomisweb.co.uk/api/v01/dataset/NM_2037_1.data.csv?date=latest&geography=633351927...633351929,633351980,633351983,633351926,633351967,633351968,633351970,633351981,633351930...633351933,633351982,633351954...633351956,633351969,633351987,633351957,633351975,633352011,633352014,633351945,633351947,633352012,633352013,633351971,633351984,633351985,633351988,633351942...633351944,633351946,633351948,633351940,633351941,633351972...633351974,633351986,633351937,633351939,633351999...633352001,633351934,633351997,633351998,633352002,633352003,633352006,633351976,633351977,633351979,633352004,633352005,633351935,633351936,633351938,633352015,633351950...633351953,633351978,633351959,633352007...633352010,633351949,633351958,633351960...633351962,633351990,633351992,633352016...633352019,633351965,633351993...633351996,633351963,633351964,633351966,633351989,633351991,633363625,633363658...633363660,633363663,633363639...633363641,633363643...633363645,633363651,633363630,633363642,633363646,633363647,633363636,633363638,633363655...633363657,633363633,633363634,633363637,633363648,633363650,633363616...633363621,633363628,633363629,633363631,633363632,633363661,633363662,633363613...633363615,633363626,633363627,633363635,633363649,633363622...633363624,633363652...633363654,633364187,633364188,633364195...633364198,633364219...633364222,633364204...633364207,633364177...633364179,633364200...633364203,633364171,633364189,633364192...633364194,633364161,633364163,633364223,633364162,633364167,633364172...633364174,633364168,633364170,633364184...633364186,633364218,633364175,633364176,633364199,633364156,633364169,633364215...633364217,633364155,633364157,633364158,633364190,633364191,633364164,633364166,633364208...633364211,633364159,633364160,633364165,633364181,633364212,633364180,633364182,633364183,633364213,633364214&c2021_hhsize_10=2&measures=20301&select=date_name,geography_name,geography_code,c2021_hhsize_10_name,measures_name,obs_value,obs_status_name')
SinglePerson <- SinglePerson %>% rename(polycode = GEOGRAPHY_CODE, value = OBS_VALUE) %>%
  add_column(IndID = "Single_Person_Hhld") %>%
  mutate(label = paste0("LSOA: ",polycode,"<br/>",
                        "Proportion of single person households = ",round(value,digits=1),"%","<br/>","<em>(2021 Census results)</em>")) %>%
  select(IndID,polycode,value,label)

# Reading Nomis data on migrant indicator

MigrantInd <- read.csv('https://www.nomisweb.co.uk/api/v01/dataset/NM_2039_1.data.csv?date=latest&geography=633351927...633351929,633351980,633351983,633351926,633351967,633351968,633351970,633351981,633351930...633351933,633351982,633351954...633351956,633351969,633351987,633351957,633351975,633352011,633352014,633351945,633351947,633352012,633352013,633351971,633351984,633351985,633351988,633351942...633351944,633351946,633351948,633351940,633351941,633351972...633351974,633351986,633351937,633351939,633351999...633352001,633351934,633351997,633351998,633352002,633352003,633352006,633351976,633351977,633351979,633352004,633352005,633351935,633351936,633351938,633352015,633351950...633351953,633351978,633351959,633352007...633352010,633351949,633351958,633351960...633351962,633351990,633351992,633352016...633352019,633351965,633351993...633351996,633351963,633351964,633351966,633351989,633351991,633363625,633363658...633363660,633363663,633363639...633363641,633363643...633363645,633363651,633363630,633363642,633363646,633363647,633363636,633363638,633363655...633363657,633363633,633363634,633363637,633363648,633363650,633363616...633363621,633363628,633363629,633363631,633363632,633363661,633363662,633363613...633363615,633363626,633363627,633363635,633363649,633363622...633363624,633363652...633363654,633364187,633364188,633364195...633364198,633364219...633364222,633364204...633364207,633364177...633364179,633364200...633364203,633364171,633364189,633364192...633364194,633364161,633364163,633364223,633364162,633364167,633364172...633364174,633364168,633364170,633364184...633364186,633364218,633364175,633364176,633364199,633364156,633364169,633364215...633364217,633364155,633364157,633364158,633364190,633364191,633364164,633364166,633364208...633364211,633364159,633364160,633364165,633364181,633364212,633364180,633364182,633364183,633364213,633364214&c2021_migind_4=0,3&measures=20100&select=geography_code,c2021_migind_4_name,obs_value') %>%
  pivot_wider(names_from = C2021_MIGIND_4_NAME,values_from = OBS_VALUE) %>%
  mutate(value = `Migrant from within the UK: Address one year ago was in the UK`/`Total: All usual residents`*100) %>%
  add_column(IndID = "Migrant_Indicator") %>%
  rename(polycode = GEOGRAPHY_CODE) %>%
  mutate(label = paste0("LSOA: ",polycode,"<br/>",
                        "Proportion of residents <br/>at different UK address one year previously = ",round(value,digits=1),"%","<br/>","<em>(2021 Census results)</em>")) %>%
  select(IndID,polycode,value,label)

# Reading Nomis data on private rented tenure

PrivRent <- read.csv('https://www.nomisweb.co.uk/api/v01/dataset/NM_2072_1.data.csv?date=latest&geography=633351927...633351929,633351980,633351983,633351926,633351967,633351968,633351970,633351981,633351930...633351933,633351982,633351954...633351956,633351969,633351987,633351957,633351975,633352011,633352014,633351945,633351947,633352012,633352013,633351971,633351984,633351985,633351988,633351942...633351944,633351946,633351948,633351940,633351941,633351972...633351974,633351986,633351937,633351939,633351999...633352001,633351934,633351997,633351998,633352002,633352003,633352006,633351976,633351977,633351979,633352004,633352005,633351935,633351936,633351938,633352015,633351950...633351953,633351978,633351959,633352007...633352010,633351949,633351958,633351960...633351962,633351990,633351992,633352016...633352019,633351965,633351993...633351996,633351963,633351964,633351966,633351989,633351991,633363625,633363658...633363660,633363663,633363639...633363641,633363643...633363645,633363651,633363630,633363642,633363646,633363647,633363636,633363638,633363655...633363657,633363633,633363634,633363637,633363648,633363650,633363616...633363621,633363628,633363629,633363631,633363632,633363661,633363662,633363613...633363615,633363626,633363627,633363635,633363649,633363622...633363624,633363652...633363654,633364187,633364188,633364195...633364198,633364219...633364222,633364204...633364207,633364177...633364179,633364200...633364203,633364171,633364189,633364192...633364194,633364161,633364163,633364223,633364162,633364167,633364172...633364174,633364168,633364170,633364184...633364186,633364218,633364175,633364176,633364199,633364156,633364169,633364215...633364217,633364155,633364157,633364158,633364190,633364191,633364164,633364166,633364208...633364211,633364159,633364160,633364165,633364181,633364212,633364180,633364182,633364183,633364213,633364214&c2021_tenure_9=1004&measures=20100,20301&select=geography_code,measures_name,obs_value') %>%
  pivot_wider(names_from = MEASURES_NAME, values_from = OBS_VALUE) %>%
  rename(polycode = GEOGRAPHY_CODE, value = Percent,housecount = Value) %>%
  add_column(IndID = "Private_rented_LSOA") %>%
  mutate(label = paste0("LSOA: ",polycode,"<br/>",
                        housecount," properties are privately rented, <br/>",
                        "which is ",round(value,digits=1),"% of the housing stock <br/>",
                        "(England average 20.5%) <br/>",
                        "<em>(2021 Census results)</em>")) %>%
  select(IndID,polycode,value,label)
                      
Nomisdata <- bind_rows(SinglePerson,MigrantInd,PrivRent)

write_csv(Nomisdata,"Nomis_LSOA.csv")